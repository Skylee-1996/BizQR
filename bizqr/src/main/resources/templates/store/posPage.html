<meta charset="UTF-8">
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<th:block th:replace="~{layout :: setFragment(~{this::content})}">
    <th:block th:fragment="content">
        <head>
            <script src="https://cdn.iamport.kr/v1/iamport.js"></script>
            <link rel="stylesheet" href="/css/store/posPage.css" />
            <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" />
            <link href='https://unpkg.com/boxicons@2.1.1/css/boxicons.min.css' rel='stylesheet'>
        </head>
        <body>
<form action="/store/posPage">

    <!-- header -->
    <nav>
        <div class="nav-bar">
            <i class='bx bx-menu sidebarOpen' ></i>
            <span class="logo navLogo"><a href="#">POS for BizQR</a></span>
            <div class="menu">
                <div class="logo-toggle">
                    <span class="logo"><a href="#">CodingLab</a></span>
                    <i class='bx bx-x siderbarClose'></i>
                </div>
                <ul class="nav-links">
                    <li><a href="/">BizQR</a></li>
                    <li><a href="#">menu2</a></li>
                    <li><a href="#">menu3</a></li>
                    <li><a href="#">menu4</a></li>
                    <li><a href="#">menu5</a></li>
                </ul>
            </div>
            <div class="darkLight-searchBox">
                <div class="dark-light">
                    <i class='bx bx-moon moon'></i>
                    <i class='bx bx-sun sun'></i>
                </div>

            </div>
        </div>
    </nav>
    <!-- header end -->

    <!-- content -->
    <div class="card-container">
        <th:block th:each="tvo:${list}">
            <div class="card">
                <h3 class="blog-title" th:text="'Table' + ${tvo.tableId}"></h3>
                <p class="description">
                    메뉴:
                    <th:block th:each="order:${tvo.orderHistory}">
                        <span th:text="${order.menuName} + ' (' + ${order.menuAmount} + ')'"></span>
                    </th:block>
                </p>
                <div class="options">
                    <span th:text="'총 금액: ' + ${tvo.totalMoney} + '원'"></span>
                    <button type="button" class="btn tablePay" id="'button' + ${tvo.tableId}"
                    th:data-tableid="${tvo.tableId}"
                    th:data-storeid="${tvo.storeId}"
                    th:data-totalprice="${tvo.totalMoney}">추가</button>
                </div>
            </div>
        </th:block>


<!--    <div class="card">-->
<!--        <h3 class="blog-title">Table 1</h3>-->
<!--        <p class="description">-->
<!--            메뉴: (개수)-->
<!--        </p>-->
<!--        <div class="options">-->
<!--    <span>-->
<!--      총 금액: 원-->
<!--    </span>-->
<!--            <button class="btn">추가</button>-->
<!--        </div>-->
<!--    </div>-->

<!--    <div class="card">-->
<!--        <h3 class="blog-title">Table 2</h3>-->
<!--        <p class="description">-->
<!--            메뉴: (개수)-->
<!--        </p>-->
<!--        <div class="options">-->
<!--    <span>-->
<!--      총 금액: 원-->
<!--    </span>-->
<!--            <button class="btn">추가</button>-->
<!--        </div>-->
<!--    </div>-->

<!--    <div class="card">-->
<!--        <h3 class="blog-title">Table 3</h3>-->
<!--        <p class="description">-->
<!--            메뉴: (개수)-->
<!--        </p>-->
<!--        <div class="options">-->
<!--    <span>-->
<!--      총 금액: 원-->
<!--    </span>-->
<!--            <button class="btn">추가</button>-->
<!--        </div>-->
<!--    </div>-->

<!--    <div class="card">-->
<!--        <h3 class="blog-title">Table 4</h3>-->
<!--        <p class="description">-->
<!--            메뉴: (개수)-->
<!--        </p>-->
<!--        <div class="options">-->
<!--    <span>-->
<!--      총 금액: 원-->
<!--    </span>-->
<!--            <button class="btn">추가</button>-->
<!--        </div>-->
<!--    </div>-->

<!--    <div class="card">-->
<!--        <h3 class="blog-title">Table 5</h3>-->
<!--        <p class="description">-->
<!--            메뉴: (개수)-->
<!--        </p>-->
<!--        <div class="options">-->
<!--    <span>-->
<!--      총 금액: 원-->
<!--    </span>-->
<!--            <button class="btn">추가</button>-->
<!--        </div>-->
<!--    </div>-->

<!--    <div class="card">-->
<!--        <h3 class="blog-title">Table 6</h3>-->
<!--        <p class="description">-->
<!--            메뉴: (개수)-->
<!--        </p>-->
<!--        <div class="options">-->
<!--    <span>-->
<!--      총 금액: 원-->
<!--    </span>-->
<!--            <button class="btn">추가</button>-->
<!--        </div>-->
<!--    </div>-->

<!--    <div class="card">-->
<!--        <h3 class="blog-title">Table 7</h3>-->
<!--        <p class="description">-->
<!--            메뉴: (개수)-->
<!--        </p>-->
<!--        <div class="options">-->
<!--    <span>-->
<!--      총 금액: 원-->
<!--    </span>-->
<!--            <button class="btn">추가</button>-->
<!--        </div>-->
<!--    </div>-->

<!--    <div class="card">-->
<!--        <h3 class="blog-title">Table 8</h3>-->
<!--        <p class="description">-->
<!--            메뉴: (개수)-->
<!--        </p>-->
<!--        <div class="options">-->
<!--    <span>-->
<!--      총 금액: 원-->
<!--    </span>-->
<!--            <button class="btn">추가</button>-->
<!--        </div>-->
<!--    </div>-->

<!--    <div class="card">-->
<!--        <h3 class="blog-title">Table 9</h3>-->
<!--        <p class="description">-->
<!--            메뉴: (개수)-->
<!--        </p>-->
<!--        <div class="options">-->
<!--    <span>-->
<!--      총 금액: 원-->
<!--    </span>-->
<!--            <button class="btn">추가</button>-->
<!--        </div>-->
<!--    </div>-->

<!--    <div class="card">-->
<!--        <h3 class="blog-title">Table 10</h3>-->
<!--        <p class="description">-->
<!--            메뉴: (개수)-->
<!--        </p>-->
<!--        <div class="options">-->
<!--    <span>-->
<!--      총 금액: 원-->
<!--    </span>-->
<!--            <button class="btn">추가</button>-->
<!--        </div>-->
<!--    </div>-->

<!--        <div class="card">-->
<!--            <h3 class="blog-title">Table 11</h3>-->
<!--            <p class="description">-->
<!--                메뉴: (개수)-->
<!--            </p>-->
<!--            <div class="options">-->
<!--    <span>-->
<!--      총 금액: 원-->
<!--    </span>-->
<!--                <button class="btn">추가</button>-->
<!--            </div>-->
<!--        </div>-->

<!--        <div class="card">-->
<!--            <h3 class="blog-title">Table 12</h3>-->
<!--            <p class="description">-->
<!--                메뉴: (개수)-->
<!--            </p>-->
<!--            <div class="options">-->
<!--    <span>-->
<!--      총 금액: 원-->
<!--    </span>-->
<!--                <button class="btn">추가</button>-->
<!--            </div>-->
<!--        </div>-->
    </div>
    <!-- content end -->

</form>
<script src="/js/store/posPage.js"></script>
<script type="text/javascript">
    var IMP = window.IMP;
    IMP.init("imp88712442");


    document.addEventListener('click', (e) => {
        console.log(e.target);

        if(e.target.classList.contains('tablePay')){
            let storeId = e.target.dataset.storeid;
            let tableId = e.target.dataset.tableid;
            let totalPrice = e.target.dataset.totalprice;
            console.log("store ID : " + storeId);
            console.log("table ID : " + tableId);
            console.log("total price : " + totalPrice);

            let currentDate = new Date();

            // 년, 월, 일, 시, 분, 초를 추출
            let year = currentDate.getFullYear(); // 년
            let month = ('0' + (currentDate.getMonth() + 1)).slice(-2); // 월 (0부터 시작하므로 +1, 두 자리로 표시)
            let day = ('0' + currentDate.getDate()).slice(-2); // 일 (두 자리로 표시)
            let hours = ('0' + currentDate.getHours()).slice(-2); // 시 (두 자리로 표시)
            let minutes = ('0' + currentDate.getMinutes()).slice(-2); // 분 (두 자리로 표시)
            let seconds = ('0' + currentDate.getSeconds()).slice(-2); // 초 (두 자리로 표시)

            let nowTime = year + '-' + month + '-' + day + ' ' + hours + ':' + minutes + ':' + seconds;

            console.log(nowTime);

            let merchant_uid = "bizqrtable" + new Date().getTime();

            IMP.request_pay(
                {
                    pg: "html5_inicis.INIpayTest",
                    pay_method: "card",
                    merchant_uid: merchant_uid,
                    name: "식사",
                    amount: totalPrice
                },
                function (rsp){
                    if(rsp.success){
                        alert('결제 완료. 결제 내역' + rsp.imp_uid);

                        let payData = {
                            impUid : rsp.imp_uid,
                            merchant_uid: merchant_uid,
                            storeId: storeId,
                            tableId: tableId,
                            totalPrice: totalPrice,
                            paidTime: nowTime
                        };
                        saveTablePayHistory(payData).then(result => {
                            if(result === '1'){
                                deleteTableOrderHistory(storeId, tableId).then(result => {
                                    if(result === '1'){
                                        //페이지 리로드
                                        window.location.href = window.location.pathname;
                                    }
                                })
                            }
                        })
                    }
                }
            )
        }
    });

    async function saveTablePayHistory(data){
        try {
            const url = "/store/saveTablePayHistory";
            const config = {
                method: 'post',
                headers: {
                    'content-type':'application/json; charset=utf-8'
                },
                body: JSON.stringify(data)
            };

            const resp = await fetch(url, config);
            const result = resp.text();
            return result;

        }catch (error){
            console.log(error);
        }
    }

    async function deleteTableOrderHistory(storeId, tableId){
        try {
            const combinedTableId = `${storeId}_${tableId}`;
            const url = `/store/deleteTableOrderHistory/` + storeId + '/' + combinedTableId;
            const config = {
                method: 'delete',
                headers: {
                    'content-type':'application/json; charset=utf-8'
                },
            }

            const resp = await fetch(url, config);
            const result = await resp.text();
            return result;

        }catch (error){
            console.log(error);
        }
    }

    // setInterval(()=>{
    //
    // })

</script>
</body>
    </th:block>
</th:block>
</html>
